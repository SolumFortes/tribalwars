// ==UserScript==
// @name         AutoFarm
// @namespace    http://tampermonkey.net/
// @version      1.5
// @description  Automatické posílání farmení s pomocníkem rabování
// @author       Wwww
// @match        https://*/game.php?village=*&screen=am_farm
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    const farmDelayMin = 1000; // Minimální zpoždění mezi odesláním útoků (v ms)
    const farmDelayMax = 2000; // Maximální zpoždění mezi odesláním útoků (v ms)
    const sendUnitsTimes = 5;  // Kolikrát kliknout na odeslání jednotek, než obnovíme stránku
    const farmIconsSelector = '.farm_icon_a'; // Selektor pro tlačítka pro odeslání jednotek
    const helperFarmButtonSelector = 'a#manager_icon_farm'; // Selektor pro tlačítko Pomocníka rabování

    let isScriptActive = false; // Počáteční stav, že skript není aktivní

    // ========================
    // Vytvoření tlačítka pro zapnutí/vypnutí skriptu
    // ========================
    function createToggleButton() {
        const button = document.createElement("button");
        button.innerHTML = isScriptActive ? "AutoFarm - ON" : "AutoFarm - OFF"; // Tlačítko bude výchozí podle stavu
        button.style.position = "fixed";
        button.style.top = "calc(50% - 50px)"; // Posuneme tlačítko o 50px výš (45px + 5px)
        button.style.left = "10px"; // Umístíme tlačítko na levý okraj
        button.style.transform = "translateY(-50%)"; // Vycentrování tlačítka
        button.style.zIndex = "1000";
        button.style.padding = "12px 24px";
        button.style.backgroundColor = isScriptActive ? "#4CAF50" : "#F44336"; // Zelené pro ON, červené pro OFF
        button.style.color = "white";
        button.style.fontSize = "16px"; // Zvýšený text
        button.style.fontWeight = "bold"; // Tučný text
        button.style.border = "none";
        button.style.borderRadius = "8px"; // Zaoblené rohy
        button.style.cursor = "pointer";
        button.style.boxShadow = "0 4px 6px rgba(0, 0, 0, 0.1)";
        button.style.transition = "background-color 0.3s, color 0.3s"; // Plynulé přechody

        button.onclick = function () {
            // Případné přepnutí stavu skriptu
            isScriptActive = !isScriptActive;
            localStorage.setItem('autoFarmActive', isScriptActive.toString());
            button.innerHTML = isScriptActive ? "AutoFarm - ON" : "AutoFarm - OFF";
            button.style.backgroundColor = isScriptActive ? "#4CAF50" : "#F44336";

            if (isScriptActive) {
                startFarming(); // Začneme farmaření, když je skript zapnutý
            }
        };

        document.body.appendChild(button); // Přidáme tlačítko do stránky
    }

    // ========================
    // FCE: Kliknutí na pomocníka rabování
    // ========================
    function clickFarmHelper() {
        const farmHelperButton = document.querySelector(helperFarmButtonSelector);
        if (farmHelperButton) {
            farmHelperButton.click();
            setTimeout(startFarming, 1000); // Začneme posílat jednotky po malém zpoždění
        }
    }

    // ========================
    // FCE: Automatické klikání na odeslání jednotek
    // ========================
    let clickCount = 0; // Počet kliknutí

    function clickSendUnits() {
        if (!isScriptActive) return; // Pokud je skript vypnutý, nic se nestane

        const farmIcons = document.querySelectorAll(farmIconsSelector);
        if (farmIcons.length > 0) {
            const randomLink = farmIcons[Math.floor(Math.random() * farmIcons.length)];
            randomLink.click(); // Kliknutí na náhodnou farmu

            clickCount++;

            if (clickCount >= sendUnitsTimes) {
                location.reload(); // Obnovíme stránku po 5 odesláních
            } else {
                const randomDelay = Math.floor(Math.random() * (farmDelayMax - farmDelayMin + 1)) + farmDelayMin;
                setTimeout(clickSendUnits, randomDelay); // Další kliknutí po náhodném zpoždění
            }
        }
    }

    // ========================
    // Hlavní logika skriptu
    // ========================

    // Načteme stav skriptu z localStorage, abychom věděli, zda je aktivní i po obnovení stránky
    const savedStatus = localStorage.getItem('autoFarmActive');
    if (savedStatus === 'true') {
        isScriptActive = true;
    }

    // Vytvoříme tlačítko pro zapnutí/vypnutí
    createToggleButton();

    // Funkce pro zahájení farmaření
    function startFarming() {
        if (isScriptActive) {
            if (window.location.href.includes("screen=am_farm")) {
                clickSendUnits(); // Na stránce farmy, začínáme odesílat jednotky
            } else {
                clickFarmHelper(); // Nejsem na stránce farmy, klikáme na pomocníka rabování
            }
        }
    }

    // Načítání stavu a zahájení farmaření při načítání stránky
    startFarming();

})();
