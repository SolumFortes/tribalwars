// ==UserScript==
// @name         Stable Recruit
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Automates stable recruitment in Tribal Wars for light and heavy cavalry.
// @author       Wwwww
// @match        https://*/game.php?village=*screen=stable*
// @grant        none
// @icon         https://dscs.innogamescdn.com/asset/07220f21/graphic/buildings/stable.png
// ==/UserScript==

(function () {
    'use strict';

    console.log('[Stable Recruit] Script started');

    // **Uložení a načítání dat z localStorage**
    function saveData(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
    }

    function loadData(key, defaultValue) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
    }

    // **Logování akcí**
    function log(message) {
        console.log(`[Stable Recruit] ${message}`);
    }

    // **Vytvoření tlačítka ON/OFF**
    const button = document.createElement('button');
    button.id = 'autoRekrutButton';
    const scriptStatus = loadData('scriptStatus', false);
    button.textContent = scriptStatus ? 'Stable - ON' : 'Stable - OFF';
    button.style.backgroundColor = scriptStatus ? 'green' : 'red';
    button.style.position = 'fixed';
    button.style.left = '10px';
    button.style.top = '50%';
    button.style.transform = 'translateY(-50%)';
    button.style.padding = '10px';
    button.style.fontSize = '16px';
    button.style.border = 'none';
    button.style.borderRadius = '5px';
    button.style.color = 'white';
    button.style.cursor = 'pointer';
    button.style.zIndex = '1000';

    button.onclick = function () {
        const isOn = button.textContent === 'Stable - ON';
        button.textContent = isOn ? 'Stable - OFF' : 'Stable - ON';
        button.style.backgroundColor = isOn ? 'red' : 'green';
        saveData('scriptStatus', !isOn);
        log(`Script turned ${isOn ? 'OFF' : 'ON'}`);
        if (!isOn) startScript();
    };

    document.body.appendChild(button);

    // **Vytvoření tabulky pro nastavení**
    const tableContainer = document.createElement('div');
    tableContainer.style.position = 'fixed';
    tableContainer.style.left = '10px';
    tableContainer.style.top = '60%';
    tableContainer.style.transform = 'translateY(-50%)';
    tableContainer.style.padding = '10px';
    tableContainer.style.border = '2px solid #8B4513';
    tableContainer.style.borderRadius = '8px';
    tableContainer.style.backgroundColor = '#F5DEB3';
    tableContainer.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';

    const table = document.createElement('table');

    // **Checkbox pro light cavalry**
    const lightCheckbox = document.createElement('input');
    lightCheckbox.type = 'checkbox';
    lightCheckbox.checked = loadData('lightChecked', false);
    lightCheckbox.onchange = () => saveData('lightChecked', lightCheckbox.checked);

    const lightImage = document.createElement('img');
    lightImage.src = 'https://dscs.innogamescdn.com/asset/07220f21/graphic/unit/unit_light.png';
    lightImage.style.width = '17px';
    lightImage.style.height = '17px';
    lightImage.style.marginRight = '5px';

    const lightRow = table.insertRow();
    const lightCell = lightRow.insertCell();
    lightCell.appendChild(lightImage);
    lightCell.appendChild(lightCheckbox);

    // **Checkbox pro heavy cavalry**
    const heavyCheckbox = document.createElement('input');
    heavyCheckbox.type = 'checkbox';
    heavyCheckbox.checked = loadData('heavyChecked', false);
    heavyCheckbox.onchange = () => saveData('heavyChecked', heavyCheckbox.checked);

    const heavyImage = document.createElement('img');
    heavyImage.src = 'https://dscs.innogamescdn.com/asset/07220f21/graphic/unit/unit_heavy.png';
    heavyImage.style.width = '17px';
    heavyImage.style.height = '17px';
    heavyImage.style.marginRight = '5px';

    const heavyRow = table.insertRow();
    const heavyCell = heavyRow.insertCell();
    heavyCell.appendChild(heavyImage);
    heavyCell.appendChild(heavyCheckbox);

    // **Časový vstup**
    const timeInput = document.createElement('input');
    timeInput.type = 'text';
    timeInput.placeholder = 'mm:ss';
    timeInput.value = loadData('timeValue', '00:00');
    timeInput.onchange = () => saveData('timeValue', timeInput.value);

    const timeRow = table.insertRow();
    timeRow.insertCell().colSpan = 2;
    timeRow.insertCell().appendChild(timeInput);

    tableContainer.appendChild(table);
    document.body.appendChild(tableContainer);

    // **Funkce pro spuštění skriptu**
    async function startScript() {
        if (!loadData('scriptStatus', false)) return;

        log('Script running...');
        try {
            const isLightChecked = lightCheckbox.checked;
            const isHeavyChecked = heavyCheckbox.checked;
            const timeValue = loadData('timeValue', '00:00');
            const [minutes, seconds] = timeValue.split(':').map(Number);
            const timeInMilliseconds = (minutes * 60 + seconds) * 1000;

            log(`Light cavalry checked: ${isLightChecked}`);
            log(`Heavy cavalry checked: ${isHeavyChecked}`);
            log(`Wait time: ${timeInMilliseconds} ms`);

            if (!isLightChecked && !isHeavyChecked) {
                log('No unit type selected, stopping...');
                await delay(30000); // Počkej 30 sekund
                location.reload(); // Obnoví stránku
                return;
            }

            const unitType = isLightChecked ? 'light' : 'heavy';
            const inputField = document.querySelector(`#${unitType}_0`);
            const recruitButton = document.querySelector('.btn-recruit');

            if (!inputField || !recruitButton) {
                log(`Element not found for ${unitType}, waiting 30 seconds before refreshing...`);
                await delay(30000); // Počkej 30 sekund
                location.reload(); // Obnoví stránku
                return;
            }

            inputField.value = 1;
            log(`Set 1 ${unitType} in the recruit field`);
            await randomDelay(500, 1000);
            recruitButton.click();
            log(`${unitType} recruited`);

            log(`Waiting for ${timeInMilliseconds} ms before refreshing page...`);
            await delay(timeInMilliseconds); // Počkej podle vyplněného času
            location.reload(); // Obnoví stránku po uplynutí čekací doby
        } catch (error) {
            log(`Error: ${error.message}`);
            await delay(30000); // Počkej 30 sekund před obnovením stránky
            location.reload(); // Obnoví stránku
        }
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function randomDelay(min, max) {
        return new Promise(resolve => setTimeout(resolve, Math.random() * (max - min) + min));
    }

    if (loadData('scriptStatus', false)) {
        startScript();
    }
})();
