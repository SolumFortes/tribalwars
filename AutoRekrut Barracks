// ==UserScript==
// @name         Barracks Recruit
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Automates barracks recruitment in Tribal Wars.
// @author       Wwww
// @match        https://*/game.php?village=*&screen=barracks*
// @grant        none
// @icon         https://dscs.innogamescdn.com/asset/07220f21/graphic/buildings/barracks.png
// ==/UserScript==

(function () {
    'use strict';

    console.log('[Barracks Recruit] Script started');

    // **Uložení a načítání dat z localStorage**
    function saveData(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
    }

    function loadData(key, defaultValue) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
    }

    // **Logování akcí**
    function log(message) {
        console.log(`[Barracks Recruit] ${message}`);
    }

    // **Vytvoření tlačítka ON/OFF**
    const button = document.createElement('button');
    button.id = 'autoRekrutButton';
    const scriptStatus = loadData('scriptStatus', false);
    button.textContent = scriptStatus ? 'Barracks - ON' : 'Barracks - OFF';
    button.style.backgroundColor = scriptStatus ? 'green' : 'red';
    button.style.position = 'fixed';
    button.style.left = '10px';
    button.style.top = '50%';
    button.style.transform = 'translateY(-50%)';
    button.style.padding = '10px';
    button.style.fontSize = '16px';
    button.style.border = 'none';
    button.style.borderRadius = '5px';
    button.style.color = 'white';
    button.style.cursor = 'pointer';
    button.style.zIndex = '1000';

    button.onclick = function () {
        const isOn = button.textContent === 'Barracks - ON';
        button.textContent = isOn ? 'Barracks - OFF' : 'Barracks - ON';
        button.style.backgroundColor = isOn ? 'red' : 'green';
        saveData('scriptStatus', !isOn);
        log(`Script turned ${isOn ? 'OFF' : 'ON'}`);
        if (!isOn) startScript();
    };

    document.body.appendChild(button);

    // **Vytvoření tabulky pro nastavení**
    const tableContainer = document.createElement('div');
    tableContainer.style.position = 'fixed';
    tableContainer.style.left = '10px';
    tableContainer.style.top = '60%';
    tableContainer.style.transform = 'translateY(-50%)';
    tableContainer.style.padding = '10px';
    tableContainer.style.border = '2px solid #8B4513';
    tableContainer.style.borderRadius = '8px';
    tableContainer.style.backgroundColor = '#F5DEB3';
    tableContainer.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';

    const table = document.createElement('table');

    // **Checkbox pro spear**
    const spearCheckbox = document.createElement('input');
    spearCheckbox.type = 'checkbox';
    spearCheckbox.checked = loadData('spearChecked', false);
    spearCheckbox.onchange = () => saveData('spearChecked', spearCheckbox.checked);

    const spearImage = document.createElement('img');
    spearImage.src = 'https://dscs.innogamescdn.com/asset/07220f21/graphic/unit/unit_spear.png';
    spearImage.style.width = '17px';
    spearImage.style.height = '17px';
    spearImage.style.marginRight = '5px';

    const spearRow = table.insertRow();
    const spearCell = spearRow.insertCell();
    spearCell.appendChild(spearImage);
    spearCell.appendChild(spearCheckbox);

    // **Checkbox pro axe**
    const axeCheckbox = document.createElement('input');
    axeCheckbox.type = 'checkbox';
    axeCheckbox.checked = loadData('axeChecked', false);
    axeCheckbox.onchange = () => saveData('axeChecked', axeCheckbox.checked);

    const axeImage = document.createElement('img');
    axeImage.src = 'https://dscs.innogamescdn.com/asset/07220f21/graphic/unit/unit_axe.png';
    axeImage.style.width = '17px';
    axeImage.style.height = '17px';
    axeImage.style.marginRight = '5px';

    const axeRow = table.insertRow();
    const axeCell = axeRow.insertCell();
    axeCell.appendChild(axeImage);
    axeCell.appendChild(axeCheckbox);

    // **Časový vstup**
    const timeInput = document.createElement('input');
    timeInput.type = 'text';
    timeInput.placeholder = 'mm:ss';
    timeInput.value = loadData('timeValue', '00:00');
    timeInput.onchange = () => saveData('timeValue', timeInput.value);

    const timeRow = table.insertRow();
    timeRow.insertCell().colSpan = 2;
    timeRow.insertCell().appendChild(timeInput);

    tableContainer.appendChild(table);
    document.body.appendChild(tableContainer);

    // **Funkce pro spuštění skriptu**
    async function startScript() {
        if (!loadData('scriptStatus', false)) return;

        log('Script running...');
        try {
            const isSpearChecked = spearCheckbox.checked;
            const isAxeChecked = axeCheckbox.checked;
            const timeValue = loadData('timeValue', '00:00');
            const [minutes, seconds] = timeValue.split(':').map(Number);
            const timeInMilliseconds = (minutes * 60 + seconds) * 1000;

            log(`Spear checked: ${isSpearChecked}`);
            log(`Axe checked: ${isAxeChecked}`);
            log(`Wait time: ${timeInMilliseconds} ms`);

            if (!isSpearChecked && !isAxeChecked) {
                log('No unit type selected, stopping...');
                await delay(30000); // Počkej 30 sekund
                location.reload(); // Obnoví stránku
                return;
            }

            const unitType = isSpearChecked ? 'spear' : 'axe';
            const inputField = document.querySelector(`#${unitType}_0`);
            const recruitButton = document.querySelector('.btn-recruit');

            if (!inputField || !recruitButton) {
                log(`Element not found for ${unitType}, waiting 30 seconds before refreshing...`);
                await delay(30000); // Počkej 30 sekund
                location.reload(); // Obnoví stránku
                return;
            }

            inputField.value = 1;
            log(`Set 1 ${unitType} in the recruit field`);
            await randomDelay(500, 1000);
            recruitButton.click();
            log(`${unitType} recruited`);

            log(`Waiting for ${timeInMilliseconds} ms before refreshing page...`);
            await delay(timeInMilliseconds); // Počkej podle vyplněného času
            location.reload(); // Obnoví stránku po uplynutí čekací doby
        } catch (error) {
            log(`Error: ${error.message}`);
            await delay(30000); // Počkej 30 sekund před obnovením stránky
            location.reload(); // Obnoví stránku
        }
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function randomDelay(min, max) {
        return new Promise(resolve => setTimeout(resolve, Math.random() * (max - min) + min));
    }

    if (loadData('scriptStatus', false)) {
        startScript();
    }
})();
